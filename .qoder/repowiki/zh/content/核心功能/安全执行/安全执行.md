# 安全执行

<cite>
**本文档中引用的文件**  
- [is_dangerous_command.rs](file://codex-rs/core/src/command_safety/is_dangerous_command.rs)
- [is_safe_command.rs](file://codex-rs/core/src/command_safety/is_safe_command.rs)
- [windows_dangerous_commands.rs](file://codex-rs/core/src/command_safety/windows_dangerous_commands.rs)
- [windows_safe_commands.rs](file://codex-rs/core/src/command_safety/windows_safe_commands.rs)
- [exec.rs](file://codex-rs/core/src/exec.rs)
- [seatbelt.rs](file://codex-rs/core/src/seatbelt.rs)
- [mod.rs](file://codex-rs/core/src/sandboxing/mod.rs)
</cite>

## 目录
1. [引言](#引言)
2. [命令安全检测机制](#命令安全检测机制)
3. [命令执行流程](#命令执行流程)
4. [沙箱策略与隔离机制](#沙箱策略与隔离机制)
5. [实际案例分析](#实际案例分析)
6. [跨平台安全策略差异](#跨平台安全策略差异)
7. [结论](#结论)

## 引言
Codex系统通过多层次的安全机制确保命令执行的安全性，包括命令安全性检测、沙箱隔离和跨平台策略适配。本文档详细说明`command_safety`模块如何实现命令安全性检测，`exec.rs`中的命令执行流程，`seatbelt.rs`中的沙箱策略，以及`sandboxing/mod.rs`中的隔离机制。

## 命令安全检测机制

Codex的命令安全检测机制通过`command_safety`模块实现，该模块包含`is_dangerous_command.rs`和`is_safe_command.rs`两个核心文件。`is_dangerous_command.rs`文件中的`requires_initial_appoval`函数根据策略、沙箱策略、命令和沙箱权限判断是否需要初始审批。`command_might_be_dangerous`函数检查命令是否可能危险，包括Windows平台特定的危险命令。

`is_safe_command.rs`文件中的`is_known_safe_command`函数判断命令是否已知安全，包括Windows平台特定的安全命令。`is_safe_to_call_with_exec`函数检查命令是否安全执行，包括对`base64`、`find`、`rg`等命令的特定选项检查。

**Section sources**
- [is_dangerous_command.rs](file://codex-rs/core/src/command_safety/is_dangerous_command.rs#L1-L154)
- [is_safe_command.rs](file://codex-rs/core/src/command_safety/is_safe_command.rs#L1-L426)

## 命令执行流程

`exec.rs`文件定义了命令执行的核心流程。`process_exec_tool_call`函数处理执行工具调用，根据沙箱策略选择适当的沙箱类型，并通过`SandboxManager`转换命令规范为执行环境。`execute_exec_env`函数执行转换后的环境，收集输出并处理超时和信号。

`exec`函数根据平台和沙箱类型选择适当的执行路径，包括Windows平台的`exec_windows_sandbox`函数。`consume_truncated_output`函数消费子进程的输出，截断输出以适合作为`shell`工具调用的输出，并强制执行指定的超时。

**Section sources**
- [exec.rs](file://codex-rs/core/src/exec.rs#L1-L966)

## 沙箱策略与隔离机制

`seatbelt.rs`文件实现了macOS平台的沙箱策略。`spawn_command_under_seatbelt`函数在seatbelt沙箱下启动命令，`create_seatbelt_command_args`函数创建seatbelt命令参数，包括文件读写策略和网络策略。

`sandboxing/mod.rs`文件定义了沙箱管理器`SandboxManager`，负责选择初始沙箱类型和转换命令规范为执行环境。`transform`函数根据沙箱类型选择适当的转换逻辑，包括macOS的seatbelt、Linux的seccomp和Windows的受限令牌沙箱。

**Section sources**
- [seatbelt.rs](file://codex-rs/core/src/seatbelt.rs#L1-L379)
- [mod.rs](file://codex-rs/core/src/sandboxing/mod.rs#L1-L179)

## 实际案例分析

### 危险命令拦截案例
当用户尝试执行`git reset`或`rm -rf /`等危险命令时，`command_might_be_dangerous`函数会检测到这些命令并返回`true`，触发审批流程。如果策略要求审批，系统会提示用户确认执行。

### 安全执行工作流
1. 用户发起命令执行请求。
2. 系统调用`process_exec_tool_call`处理请求。
3. 根据沙箱策略选择适当的沙箱类型。
4. `SandboxManager`转换命令规范为执行环境。
5. `execute_exec_env`执行转换后的环境，收集输出。
6. 如果执行超时或被信号中断，系统会处理超时和信号。
7. 返回执行结果给用户。

**Section sources**
- [is_dangerous_command.rs](file://codex-rs/core/src/command_safety/is_dangerous_command.rs#L1-L154)
- [exec.rs](file://codex-rs/core/src/exec.rs#L1-L966)

## 跨平台安全策略差异

### Windows平台
Windows平台使用受限令牌沙箱，通过`codex-windows-sandbox` crate在进程中执行。`is_dangerous_command_windows`函数检查Windows平台特定的危险命令，`is_safe_command_windows`函数检查Windows平台特定的安全命令。

### macOS平台
macOS平台使用seatbelt沙箱，通过`/usr/bin/sandbox-exec`执行。`create_seatbelt_command_args`函数创建seatbelt命令参数，包括文件读写策略和网络策略。

### Linux平台
Linux平台使用seccomp沙箱，通过`codex-linux-sandbox`可执行文件执行。`create_linux_sandbox_command_args`函数创建Linux沙箱命令参数，包括文件系统访问控制。

**Section sources**
- [windows_dangerous_commands.rs](file://codex-rs/core/src/command_safety/windows_dangerous_commands.rs)
- [windows_safe_commands.rs](file://codex-rs/core/src/command_safety/windows_safe_commands.rs)
- [seatbelt.rs](file://codex-rs/core/src/seatbelt.rs#L1-L379)
- [mod.rs](file://codex-rs/core/src/sandboxing/mod.rs#L1-L179)

## 结论
Codex通过`command_safety`模块的命令安全性检测、`exec.rs`的命令执行流程、`seatbelt.rs`的沙箱策略和`sandboxing/mod.rs`的隔离机制，实现了多层次的安全执行。不同操作系统下的安全策略差异通过平台特定的实现方案解决，确保了跨平台的安全性和一致性。