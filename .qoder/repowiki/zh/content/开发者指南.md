# 开发者指南

<cite>
**本文档中引用的文件**  
- [DEVELOPMENT.md](file://DEVELOPMENT.md)
- [justfile](file://justfile)
- [codex-rs/Cargo.toml](file://codex-rs/Cargo.toml)
- [codex-rs/rust-toolchain.toml](file://codex-rs/rust-toolchain.toml)
- [codex-rs/rustfmt.toml](file://codex-rs/rustfmt.toml)
- [codex-rs/clippy.toml](file://codex-rs/clippy.toml)
- [codex-rs/deny.toml](file://codex-rs/deny.toml)
- [codex-cli/package.json](file://codex-cli/package.json)
- [codex-cli/Dockerfile](file://codex-cli/Dockerfile)
- [codex-cli/scripts/build_container.sh](file://codex-cli/scripts/build_container.sh)
- [sdk/typescript/package.json](file://sdk/typescript/package.json)
- [sdk/typescript/eslint.config.js](file://sdk/typescript/eslint.config.js)
- [sdk/typescript/tsconfig.json](file://sdk/typescript/tsconfig.json)
- [pnpm-workspace.yaml](file://pnpm-workspace.yaml)
- [cliff.toml](file://cliff.toml)
</cite>

## 目录
1. [简介](#简介)
2. [开发环境设置](#开发环境设置)
3. [构建系统](#构建系统)
4. [测试策略](#测试策略)
5. [代码贡献流程](#代码贡献流程)
6. [故障排查](#故障排查)

## 简介

本指南为 OpenAI Codex 项目的贡献者提供全面的开发者文档。项目是一个 AI 驱动的代码助手，主要由 Rust 后端核心、Node.js CLI 封装、MCP shell 工具服务器和 TypeScript SDK 组成。本文档详细说明了本地开发环境的设置、构建系统、测试策略以及代码贡献流程。

**本节不分析具体源文件，因此不添加来源**

## 开发环境设置

### 前置要求

在开始开发之前，请确保安装以下工具：

- **Rust**: 1.90+（通过 `rust-toolchain.toml` 自动管理）
- **Node.js**: 22+（推荐使用 `.nvmrc` 配置）
- **pnpm**: 包管理器
- **Python**: 3.11+（用于构建脚本）

### 快速开始

按照以下步骤快速设置开发环境：

```bash
# 克隆仓库
git clone https://github.com/openai/codex.git
cd codex

# 安装 Node.js 依赖
pnpm install

# 构建 Rust 组件
cd codex-rs
cargo build

# 运行测试
cargo nextest run
```

**本节不分析具体源文件，因此不添加来源**

## 构建系统

### Rust 构建配置

项目使用 Cargo 作为 Rust 的构建系统，并通过 `just` 命令简化常用操作。

#### 工具链配置

Rust 工具链版本在 `rust-toolchain.toml` 中定义：

```toml
[toolchain]
channel = "1.90.0"
components = ["clippy", "rustfmt", "rust-src"]
```

#### Just 命令

`justfile` 提供了简化的构建命令：

```makefile
# 运行 codex
codex *args:
    cargo run --bin codex -- "$@"

# 格式化代码
fmt:
    cargo fmt -- --config imports_granularity=Item

# 运行测试
test:
    cargo nextest run --no-fail-fast
```

### Node.js 构建配置

Node.js 项目使用 pnpm 作为包管理器，配置在 `pnpm-workspace.yaml` 中：

```yaml
packages:
  - docs
  - sdk/typescript
  - shell-tool-mcp
```

**本节来源**
- [codex-rs/rust-toolchain.toml](file://codex-rs/rust-toolchain.toml)
- [justfile](file://justfile)
- [pnpm-workspace.yaml](file://pnpm-workspace.yaml)

## 测试策略

### Rust 测试

项目使用 `cargo-nextest` 作为主要的测试运行器，因为它比默认的 `cargo test` 更快。

#### 测试组织

测试代码组织如下：
- `codex-rs/tests/all.rs`：测试入口
- 各 crate 的 `tests/` 目录下包含具体的测试套件

#### 运行测试

```bash
# 运行所有测试
cargo nextest run

# 运行特定测试
cargo nextest run test_name
```

### TypeScript 测试

TypeScript 项目使用 Jest 作为测试框架。

#### 测试命令

```bash
# 运行所有测试
pnpm test

# 监视模式
pnpm test:watch

# 覆盖率
pnpm test:coverage
```

**本节来源**
- [DEVELOPMENT.md](file://DEVELOPMENT.md)
- [justfile](file://justfile)
- [sdk/typescript/package.json](file://sdk/typescript/package.json)

## 代码贡献流程

### 分支策略

1. Fork 仓库
2. 创建功能分支
   ```bash
   git checkout -b feature/new-feature
   ```
3. 提交更改
   ```bash
   git commit -m "feat: add new feature"
   ```
4. 推送并创建 PR

### 代码审查

- 自动化检查必须通过
- 至少一个审查者批准
- 遵循代码风格指南

### 提交规范

提交消息应遵循约定式提交（Conventional Commits）规范：
- `feat:` 添加新功能
- `fix:` 修复 bug
- `docs:` 文档更新
- `style:` 代码格式调整
- `refactor:` 代码重构
- `test:` 测试相关
- `chore:` 构建过程或辅助工具的变动

**本节来源**
- [DEVELOPMENT.md](file://DEVELOPMENT.md)

## 故障排查

### 常见问题

1. **构建失败**
   - 检查 Rust 工具链版本
   - 清理缓存：`cargo clean`
   - 更新依赖：`cargo update`

2. **测试失败**
   - 检查环境变量
   - 确保测试数据存在
   - 运行单个测试：`cargo test test_name`

3. **发布失败**
   - 验证版本号格式
   - 检查 changelog
   - 确认权限设置

### 调试技巧

#### Rust 调试

- 使用 `dbg!` 宏快速调试
- 启用详细日志：`RUST_LOG=debug`
- 使用 `cargo-expand` 查看宏展开

#### TypeScript 调试

- 使用 `debugger` 语句
- 配置 source maps
- 使用 VS Code 调试器

**本节来源**
- [DEVELOPMENT.md](file://DEVELOPMENT.md)